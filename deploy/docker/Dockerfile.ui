# --------- UI build stage ---------
FROM node:22-alpine AS build

WORKDIR /app/ui

# Copy dependency manifests (from repo root)
COPY ui/package.json ui/package-lock.json ./
RUN npm ci

# Copy UI source only (from repo root)
COPY ui/ ./

# ---- build-time env for Vite ----
ARG VITE_API_KEY
ARG VITE_API_BASE_URL=/api
ENV VITE_API_KEY=$VITE_API_KEY
ENV VITE_API_BASE_URL=$VITE_API_BASE_URL

RUN npm run build

# --------- Nginx serve stage ---------
FROM nginx:1.27-alpine AS runtime

WORKDIR /usr/share/nginx/html
COPY --from=build /app/ui/dist ./

# SPA routing + optional /api reverse proxy
# (create this file if you don't already have a suitable one)
COPY deploy/nginx/ui.conf /etc/nginx/conf.d/default.conf

CMD ["nginx", "-g", "daemon off;"]